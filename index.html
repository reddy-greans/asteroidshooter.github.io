<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>8-Bit Asteroid Hunter</title>
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Press+Start+2P&display=swap');

        body {
            background-color: #111;
            color: #eee;
            margin: 0;
            padding: 0;
            overflow: hidden;
            font-family: 'Press Start 2P', monospace; /* Retro font */
            display: flex;
            justify-content: center;
            align-items: center;
            height: 100vh;
            touch-action: none; /* Prevent zooming/scrolling on mobile */
        }

        #game-container {
            position: relative;
            width: 100%;
            height: 100%;
            max-width: 800px; /* Max width for desktop */
            max-height: 600px;
            aspect-ratio: 4/3;
            background: #000;
            border: 4px solid #444;
            box-shadow: 0 0 20px rgba(0, 255, 0, 0.2);
        }

        canvas {
            display: block;
            width: 100%;
            height: 100%;
            cursor: crosshair;
        }

        /* UI Overlays */
        #ui-layer {
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            pointer-events: none;
            display: flex;
            flex-direction: column;
            justify-content: space-between;
            padding: 20px;
            box-sizing: border-box;
        }

        #score-board {
            font-size: 20px;
            color: #fff;
            text-shadow: 2px 2px #333;
        }

        #start-screen, #game-over-screen {
            position: absolute;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            text-align: center;
            background: rgba(0, 0, 0, 0.85);
            padding: 40px;
            border: 2px solid #fff;
            pointer-events: auto;
            z-index: 10;
        }

        .hidden {
            display: none !important;
        }

        h1 {
            font-size: 30px;
            color: #0f0;
            margin-bottom: 20px;
            text-transform: uppercase;
            letter-spacing: 2px;
        }

        p {
            font-size: 14px;
            line-height: 1.5;
            color: #ccc;
            margin-bottom: 30px;
        }

        .controls-hint {
            color: #0f0;
            font-size: 12px;
            margin-top: 10px;
            padding: 10px;
            border: 1px dashed #444;
        }

        button {
            background: #0f0;
            color: #000;
            border: none;
            padding: 15px 30px;
            font-family: 'Press Start 2P', monospace;
            font-size: 16px;
            cursor: pointer;
            text-transform: uppercase;
        }

        button:hover {
            background: #fff;
        }

        /* Mobile Controls */
        #mobile-controls {
            position: absolute;
            bottom: 20px;
            left: 0;
            width: 100%;
            height: 120px;
            pointer-events: none; /* Let touches pass through to buttons */
            display: none; /* Hidden by default, shown via JS detection */
            justify-content: space-between;
            padding: 0 20px;
            box-sizing: border-box;
        }

        .control-group {
            pointer-events: auto;
            display: flex;
            gap: 15px;
            align-items: flex-end;
        }

        .touch-btn {
            width: 60px;
            height: 60px;
            background: rgba(255, 255, 255, 0.1);
            border: 2px solid rgba(255, 255, 255, 0.3);
            border-radius: 50%;
            display: flex;
            justify-content: center;
            align-items: center;
            color: white;
            font-size: 24px;
            user-select: none;
            touch-action: manipulation;
        }

        .touch-btn:active {
            background: rgba(0, 255, 0, 0.3);
            border-color: #0f0;
        }

        .touch-btn.fire {
            width: 70px;
            height: 70px;
            border-color: #f00;
            background: rgba(255, 0, 0, 0.1);
        }
        .touch-btn.fire:active {
            background: rgba(255, 0, 0, 0.4);
        }

        /* Scanline effect */
        .scanlines {
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: linear-gradient(
                to bottom,
                rgba(255,255,255,0),
                rgba(255,255,255,0) 50%,
                rgba(0,0,0,0.1) 50%,
                rgba(0,0,0,0.1)
            );
            background-size: 100% 4px;
            pointer-events: none;
            z-index: 5;
        }

        @media (max-width: 800px) {
            #game-container {
                max-width: 100%;
                max-height: 100%;
                border: none;
            }
            #mobile-controls {
                display: flex;
            }
        }
    </style>
</head>
<body>

<div id="game-container">
    <canvas id="gameCanvas"></canvas>
    <div class="scanlines"></div>

    <div id="ui-layer">
        <div id="score-board">SCORE: 0</div>
        
        <!-- Mobile Controls -->
        <div id="mobile-controls">
            <div class="control-group">
                <div class="touch-btn" id="btn-left">←</div>
                <div class="touch-btn" id="btn-right">→</div>
            </div>
            <div class="control-group">
                <div class="touch-btn" id="btn-thrust">▲</div>
                <div class="touch-btn fire" id="btn-fire">●</div>
            </div>
        </div>
    </div>

    <div id="start-screen">
        <h1>ASTEROID<br>HUNTER</h1>
        <div class="controls-hint">
            <p style="margin:5px 0; color:#fff;">CONTROLS</p>
            Move: ARROWS or WASD<br>
            Fire: SPACE or K
        </div>
        <br>
        <button id="start-btn">INSERT COIN</button>
    </div>

    <div id="game-over-screen" class="hidden">
        <h1>GAME OVER</h1>
        <p>Final Score: <span id="final-score">0</span></p>
        <button id="restart-btn">TRY AGAIN</button>
    </div>
</div>

<script>
    /**
     * GAME ENGINE & LOGIC
     */
    const canvas = document.getElementById('gameCanvas');
    const ctx = canvas.getContext('2d');
    const scoreEl = document.getElementById('score-board');
    const finalScoreEl = document.getElementById('final-score');
    const startScreen = document.getElementById('start-screen');
    const gameOverScreen = document.getElementById('game-over-screen');

    // Game State
    let gameLoopId;
    let lastTime = 0;
    let score = 0;
    let gameState = 'MENU'; // MENU, PLAYING, GAMEOVER
    let width, height;

    // Entities
    let ship;
    let asteroids = [];
    let bullets = [];
    let particles = []; // Explosion debris

    // Inputs
    const keys = {
        ArrowUp: false,
        ArrowLeft: false,
        ArrowRight: false,
        Space: false
    };

    /**
     * AUDIO SYSTEM (Simple Synthesizer)
     */
    const AudioContext = window.AudioContext || window.webkitAudioContext;
    let audioCtx;

    function initAudio() {
        if (!audioCtx) audioCtx = new AudioContext();
        if (audioCtx.state === 'suspended') audioCtx.resume();
    }

    function playSound(type) {
        if (!audioCtx) return;
        const osc = audioCtx.createOscillator();
        const gain = audioCtx.createGain();
        osc.connect(gain);
        gain.connect(audioCtx.destination);

        const now = audioCtx.currentTime;

        if (type === 'shoot') {
            osc.type = 'square';
            osc.frequency.setValueAtTime(440, now);
            osc.frequency.exponentialRampToValueAtTime(110, now + 0.1);
            gain.gain.setValueAtTime(0.1, now);
            gain.gain.exponentialRampToValueAtTime(0.01, now + 0.1);
            osc.start(now);
            osc.stop(now + 0.1);
        } else if (type === 'explode') {
            osc.type = 'sawtooth';
            osc.frequency.setValueAtTime(100, now);
            osc.frequency.exponentialRampToValueAtTime(10, now + 0.3);
            gain.gain.setValueAtTime(0.2, now);
            gain.gain.exponentialRampToValueAtTime(0.01, now + 0.3);
            osc.start(now);
            osc.stop(now + 0.3);
        } else if (type === 'thrust') {
            osc.type = 'triangle';
            osc.frequency.setValueAtTime(50, now);
            osc.frequency.linearRampToValueAtTime(30, now + 0.1);
            gain.gain.setValueAtTime(0.05, now);
            gain.gain.linearRampToValueAtTime(0, now + 0.1);
            osc.start(now);
            osc.stop(now + 0.1);
        }
    }

    /**
     * CLASSES
     */
    class Vector {
        constructor(x, y) { this.x = x; this.y = y; }
        add(v) { this.x += v.x; this.y += v.y; }
        mult(n) { this.x *= n; this.y *= n; }
    }

    class Ship {
        constructor() {
            this.pos = new Vector(width / 2, height / 2);
            this.vel = new Vector(0, 0);
            this.angle = -Math.PI / 2; // Point up
            this.radius = 10;
            this.rotationSpeed = 0.08; 
            this.thrust = 0.15;
            this.friction = 0.98; // Space friction
            this.color = '#fff';
            this.dead = false;
            this.invulnerable = 60; // Frames of invulnerability
            this.shootCooldown = 0;
        }

        update() {
            if (this.dead) return;

            // Rotation
            if (keys.ArrowLeft) this.angle -= this.rotationSpeed;
            if (keys.ArrowRight) this.angle += this.rotationSpeed;

            // Thrust
            if (keys.ArrowUp) {
                this.vel.x += Math.cos(this.angle) * this.thrust;
                this.vel.y += Math.sin(this.angle) * this.thrust;
                
                // Thrust particles
                if (Math.random() > 0.5) {
                    particles.push(new Particle(
                        this.pos.x - Math.cos(this.angle) * this.radius,
                        this.pos.y - Math.sin(this.angle) * this.radius,
                        -Math.cos(this.angle) * 2 + (Math.random() - 0.5),
                        -Math.sin(this.angle) * 2 + (Math.random() - 0.5),
                        '#fa0', 20
                    ));
                }
                if (Math.random() > 0.8) playSound('thrust');
            }

            // Physics
            this.pos.add(this.vel);
            this.vel.mult(this.friction);

            // Screen wrap
            if (this.pos.x < 0) this.pos.x = width;
            if (this.pos.x > width) this.pos.x = 0;
            if (this.pos.y < 0) this.pos.y = height;
            if (this.pos.y > height) this.pos.y = 0;

            // Cooldowns
            if (this.invulnerable > 0) this.invulnerable--;
            if (this.shootCooldown > 0) this.shootCooldown--;

            // Shooting
            if (keys.Space && this.shootCooldown <= 0) {
                this.shoot();
            }
        }

        shoot() {
            bullets.push(new Bullet(
                this.pos.x + Math.cos(this.angle) * this.radius,
                this.pos.y + Math.sin(this.angle) * this.radius,
                this.angle
            ));
            this.shootCooldown = 15;
            playSound('shoot');
        }

        draw(ctx) {
            if (this.dead) return;
            if (this.invulnerable > 0 && Math.floor(Date.now() / 100) % 2 === 0) return; // Blink

            ctx.save();
            ctx.translate(this.pos.x, this.pos.y);
            ctx.rotate(this.angle);

            ctx.strokeStyle = this.color;
            ctx.lineWidth = 2;
            ctx.beginPath();
            // Triangle shape
            ctx.moveTo(this.radius * 1.5, 0);
            ctx.lineTo(-this.radius, -this.radius);
            ctx.lineTo(-this.radius * 0.5, 0); 
            ctx.lineTo(-this.radius, this.radius);
            ctx.closePath();
            ctx.stroke();

            ctx.restore();
        }
    }

    class Asteroid {
        constructor(x, y, size) {
            this.pos = new Vector(
                x === undefined ? Math.random() * width : x,
                y === undefined ? Math.random() * height : y
            );
            
            // If random spawn, ensure not too close to center
            if (x === undefined) {
                while(Math.hypot(this.pos.x - width/2, this.pos.y - height/2) < 100) {
                    this.pos.x = Math.random() * width;
                    this.pos.y = Math.random() * height;
                }
            }

            this.vel = new Vector(
                (Math.random() - 0.5) * (4 - size/15), 
                (Math.random() - 0.5) * (4 - size/15)
            );
            this.size = size || 40; // 40=Large, 20=Med, 10=Small
            this.rotation = 0;
            this.rotSpeed = (Math.random() - 0.5) * 0.1;
        }

        update() {
            this.pos.add(this.vel);
            this.rotation += this.rotSpeed;

            // Wrap
            if (this.pos.x < -this.size) this.pos.x = width + this.size;
            if (this.pos.x > width + this.size) this.pos.x = -this.size;
            if (this.pos.y < -this.size) this.pos.y = height + this.size;
            if (this.pos.y > height + this.size) this.pos.y = -this.size;
        }

        draw(ctx) {
            ctx.save();
            ctx.translate(this.pos.x, this.pos.y);
            ctx.rotate(this.rotation);
            ctx.strokeStyle = '#fff';
            ctx.lineWidth = 2;
            
            // Square shape
            ctx.strokeRect(-this.size/2, -this.size/2, this.size, this.size);
            
            // Inner detail rectangle
            ctx.lineWidth = 1;
            ctx.strokeRect(-this.size/4, -this.size/4, this.size/2, this.size/2);

            ctx.restore();
        }
    }

    class Bullet {
        constructor(x, y, angle) {
            this.pos = new Vector(x, y);
            this.vel = new Vector(Math.cos(angle) * 7, Math.sin(angle) * 7);
            this.life = 60; 
            this.radius = 2;
        }

        update() {
            this.pos.add(this.vel);
            this.life--;

            if (this.pos.x < 0) this.pos.x = width;
            if (this.pos.x > width) this.pos.x = 0;
            if (this.pos.y < 0) this.pos.y = height;
            if (this.pos.y > height) this.pos.y = 0;
        }

        draw(ctx) {
            ctx.fillStyle = '#ff0';
            ctx.fillRect(this.pos.x - 2, this.pos.y - 2, 4, 4);
        }
    }

    class Particle {
        constructor(x, y, vx, vy, color, life) {
            this.pos = new Vector(x, y);
            this.vel = new Vector(vx, vy);
            this.color = color;
            this.life = life;
            this.maxLife = life;
        }
        
        update() {
            this.pos.add(this.vel);
            this.life--;
        }

        draw(ctx) {
            ctx.globalAlpha = this.life / this.maxLife;
            ctx.fillStyle = this.color;
            ctx.fillRect(this.pos.x, this.pos.y, 3, 3);
            ctx.globalAlpha = 1.0;
        }
    }

    /**
     * INITIALIZATION & HELPERS
     */
    function resize() {
        const container = document.getElementById('game-container');
        width = canvas.width = container.clientWidth;
        height = canvas.height = container.clientHeight;
    }

    function spawnAsteroids(count) {
        for(let i=0; i<count; i++) {
            asteroids.push(new Asteroid(undefined, undefined, 40));
        }
    }

    function createExplosion(x, y, count, color = '#fff') {
        playSound('explode');
        for (let i = 0; i < count; i++) {
            const angle = Math.random() * Math.PI * 2;
            const speed = Math.random() * 3;
            particles.push(new Particle(
                x, y,
                Math.cos(angle) * speed,
                Math.sin(angle) * speed,
                color,
                30 + Math.random() * 20
            ));
        }
    }

    function checkCollisions() {
        // Bullet vs Asteroid
        for (let i = bullets.length - 1; i >= 0; i--) {
            let b = bullets[i];
            for (let j = asteroids.length - 1; j >= 0; j--) {
                let a = asteroids[j];
                let dist = Math.hypot(b.pos.x - a.pos.x, b.pos.y - a.pos.y);
                
                if (dist < a.size / 1.5 + b.radius) {
                    bullets.splice(i, 1);
                    createExplosion(a.pos.x, a.pos.y, 10);
                    
                    if (a.size > 15) {
                        asteroids.push(new Asteroid(a.pos.x, a.pos.y, a.size / 2));
                        asteroids.push(new Asteroid(a.pos.x, a.pos.y, a.size / 2));
                    }
                    
                    score += (45 - a.size);
                    scoreEl.innerText = `SCORE: ${score}`;
                    
                    asteroids.splice(j, 1);
                    break;
                }
            }
        }

        // Ship vs Asteroid
        if (!ship.dead && ship.invulnerable <= 0) {
            for (let a of asteroids) {
                let dist = Math.hypot(ship.pos.x - a.pos.x, ship.pos.y - a.pos.y);
                if (dist < ship.radius + a.size / 2) {
                    gameOver();
                    break;
                }
            }
        }
    }

    function gameOver() {
        ship.dead = true;
        createExplosion(ship.pos.x, ship.pos.y, 50, '#f00');
        gameState = 'GAMEOVER';
        finalScoreEl.innerText = score;
        gameOverScreen.classList.remove('hidden');
    }

    function resetGame() {
        score = 0;
        scoreEl.innerText = "SCORE: 0";
        ship = new Ship();
        asteroids = [];
        bullets = [];
        particles = [];
        spawnAsteroids(4);
        gameState = 'PLAYING';
        gameOverScreen.classList.add('hidden');
        startScreen.classList.add('hidden');
        initAudio();
    }

    /**
     * MAIN LOOP
     */
    function loop(timestamp) {
        ctx.fillStyle = '#000';
        ctx.fillRect(0, 0, width, height);

        if (gameState === 'PLAYING') {
            ship.update();
            bullets.forEach((b, i) => {
                b.update();
                if (b.life <= 0) bullets.splice(i, 1);
            });
            asteroids.forEach(a => a.update());
            particles.forEach((p, i) => {
                p.update();
                if (p.life <= 0) particles.splice(i, 1);
            });
            
            checkCollisions();

            if (asteroids.length === 0) {
                spawnAsteroids(5 + Math.floor(score / 500));
                ship.invulnerable = 60;
                ship.pos = new Vector(width/2, height/2);
                ship.vel = new Vector(0,0);
            }

            ship.draw(ctx);
            bullets.forEach(b => b.draw(ctx));
            asteroids.forEach(a => a.draw(ctx));
            particles.forEach(p => p.draw(ctx));
        }

        gameLoopId = requestAnimationFrame(loop);
    }

    /**
     * INPUT HANDLING - Updated for PC WASD Support
     */
    window.addEventListener('keydown', e => {
        // Thrust: ArrowUp or W
        if (e.code === 'ArrowUp' || e.code === 'KeyW') keys.ArrowUp = true;
        
        // Left: ArrowLeft or A
        if (e.code === 'ArrowLeft' || e.code === 'KeyA') keys.ArrowLeft = true;
        
        // Right: ArrowRight or D
        if (e.code === 'ArrowRight' || e.code === 'KeyD') keys.ArrowRight = true;
        
        // Fire: Space or K
        if (e.code === 'Space' || e.code === 'KeyK') {
            keys.Sp
